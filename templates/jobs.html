{% extends "base.html" %}

{% block title %}Les offres d'emplois - AIrh{% endblock %}

{% block content %}
<style>
    .jobs-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 1rem;
        padding: 1.5rem;
        min-height: 400px;
    }

    .job-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1.25rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .job-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .job-header {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #f3f4f6;
    }

    .job-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.25rem;
    }

    .job-company {
        font-size: 0.875rem;
        color: var(--primary-color);
        font-weight: 500;
    }

    .job-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .job-info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #4B5563;
        font-size: 0.8rem;
    }

    .job-info-item i {
        color: var(--primary-color);
        width: 14px;
        text-align: center;
        font-size: 0.75rem;
    }

    .job-description {
        margin-bottom: 1rem;
    }

    .job-description-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .job-description-text {
        font-size: 0.8rem;
        color: #6B7280;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .job-actions {
        margin-top: auto;
        display: flex;
        gap: 0.5rem;
        justify-content: flex-start;
    }

    .job-link, .interview-link {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 0.875rem;
        color: white;
        text-decoration: none;
        border-radius: 0.375rem;
        text-align: center;
        transition: all 0.2s;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .job-link {
        background: var(--primary-color);
        flex: 1;
    }

    .job-link:hover {
        background: var(--secondary-color);
        color: white;
    }

    .interview-link {
        background: #10B981;
        flex: 1;
    }

    .interview-link:hover {
        background: #059669;
        color: white;
    }

    .page-header {
        padding: 1.5rem 1.5rem 0;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: #6B7280;
        font-size: 0.95rem;
    }

    .jobs-count {
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    /* Search Styles */
    .search-container {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    /* Stats Styles */
    .stats-container {
        margin: 1.5rem 0;
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid #f3f4f6;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
    }

    .stat-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 0.5rem;
        transition: all 0.2s;
        border: 1px solid #e2e8f0;
    }

    .stat-card:hover {
        background: #f1f5f9;
        transform: translateY(-1px);
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .stat-card:nth-child(1) .stat-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .stat-card:nth-child(2) .stat-icon {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .stat-card:nth-child(3) .stat-icon {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .stat-card:nth-child(4) .stat-icon {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .stat-card:nth-child(5) .stat-icon {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
    }

    .stat-card:nth-child(6) .stat-icon {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
    }

    .stat-content {
        flex: 1;
        min-width: 0;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        line-height: 1;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6b7280;
        font-weight: 500;
        margin-top: 0.25rem;
    }

    .search-input-wrapper {
        position: relative;
        max-width: 600px;
        margin: 0 auto;
    }

    .search-input {
        width: 100%;
        padding: 0.875rem 3rem 0.875rem 2.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        font-size: 1rem;
        background: white;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 0.9rem;
    }

    .clear-search {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: #f3f4f6;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #6b7280;
        transition: all 0.2s;
    }

    .clear-search:hover {
        background: #e5e7eb;
        color: #374151;
    }

    .search-results-info {
        text-align: center;
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .search-highlight {
        background: rgba(99, 102, 241, 0.1);
        border-radius: 0.25rem;
        padding: 0.125rem 0.25rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    .job-card.hidden {
        display: none !important;
    }

    /* Pagination Styles */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem 1.5rem;
        margin-top: auto;
    }

    .pagination {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .pagination-item {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
        cursor: pointer;
    }

    .pagination-item:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .pagination-item.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .pagination-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .pagination-dots {
        padding: 0 0.5rem;
        color: #9ca3af;
        font-weight: 500;
    }

    .pagination-nav {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        text-decoration: none;
        transition: all 0.2s;
        cursor: pointer;
    }

    .pagination-nav:hover:not(.disabled) {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }

    .pagination-nav.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

        @media (max-width: 768px) {
        .jobs-container {
            grid-template-columns: 1fr;
            padding: 1rem;
        }
        
        .job-info {
            grid-template-columns: 1fr;
        }
        
        .job-actions {
            flex-direction: column;
        }

        .pagination {
            gap: 0.25rem;
        }

        .pagination-item, .pagination-nav {
            width: 35px;
            height: 35px;
            font-size: 0.8rem;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .stat-card {
            padding: 0.75rem;
        }

        .stat-icon {
            width: 35px;
            height: 35px;
            font-size: 1rem;
        }

        .stat-number {
            font-size: 1.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
        }

        .search-container {
            margin-top: 1rem;
        }
    }
</style>

<div class="page-header">
    <h1 class="page-title">
        Offres d'emploi
        <span class="jobs-count" id="totalCount">{{ jobs|length }} offre{% if jobs|length > 1 %}s{% endif %}</span>
    </h1>
    <p class="page-subtitle">Découvrez les opportunités disponibles et lancez votre entretien de simulation</p>
    
    <!-- Statistiques des offres -->
    <div class="stats-container" id="statsContainer">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="statAlternance">0</div>
                    <div class="stat-label">Alternance</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="statCDI">0</div>
                    <div class="stat-label">CDI</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="statCDD">0</div>
                    <div class="stat-label">CDD</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="statStage">0</div>
                    <div class="stat-label">Stage</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="statSansDiplome">0</div>
                    <div class="stat-label">Sans diplôme</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="statJunior">0</div>
                    <div class="stat-label">Junior</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Barre de recherche -->
    <div class="search-container">
        <div class="search-input-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="Recherchez par mots-clés : poste, compétences, type de contrat..."
                autocomplete="off"
            >
            <button id="clearSearch" class="clear-search" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-results-info" id="searchResultsInfo"></div>
    </div>
</div>

<div class="jobs-container" id="jobsContainer">
    {% for job in jobs %}
    <div class="job-card" data-job-index="{{ loop.index0 }}">
        <div class="job-header">
            <h2 class="job-title">{{ job.poste }}</h2>
            <div class="job-company">{{ job.entreprise }}</div>
        </div>
        
        <div class="job-info">
            <div class="job-info-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>{{ job.ville }}</span>
            </div>
            <div class="job-info-item">
                <i class="fas fa-file-contract"></i>
                <span>{{ job.contrat }}</span>
            </div>
            <div class="job-info-item">
                <i class="fas fa-calendar-alt"></i>
                <span>{{ job.publication }}</span>
            </div>
        </div>

        {% if job.get('description_nettoyee') %}
        <div class="job-description">
            <div class="job-description-title">Description</div>
            <div class="job-description-text">{{ job.description_nettoyee }}</div>
        </div>
        {% endif %}

        <div class="job-actions">
            <a href="{{ job.lien }}" target="_blank" class="job-link">
                <i class="fas fa-external-link-alt"></i>
                Voir l'offre
            </a>
            <a href="{{ url_for('interview_ai', job_id=job.id) }}" class="interview-link">
                <i class="fas fa-microphone"></i>
                Entretien
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<div class="pagination-container">
    <nav class="pagination" id="pagination">
        <!-- La pagination sera générée par JavaScript -->
    </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script src="https://cdn.jsdelivr.net/npm/natural@6.12.0/dist/natural.min.js"></script>

<script>
class SmartJobSearch {
    constructor() {
        // Synonymes métier pour améliorer la recherche
        this.synonyms = {
            'data': ['données', 'database', 'base de données', 'bdd'],
            'analyste': ['analyst', 'analyse', 'analytics', 'analytique'],
            'développeur': ['dev', 'developer', 'programmeur', 'codeur', 'développeuse'],
            'alternance': ['apprentissage', 'contrat pro', 'formation', 'apprenti'],
            'stage': ['stagiaire', 'internship', 'période', 'intern'],
            'junior': ['débutant', 'entry level', 'première expérience', 'jeune diplôme'],
            'senior': ['expérimenté', 'expert', 'confirmé', 'lead'],
            'python': ['py', 'django', 'flask', 'pandas'],
            'javascript': ['js', 'react', 'vue', 'angular', 'node'],
            'sql': ['mysql', 'postgresql', 'oracle', 'database']
        };
        
        // Configuration Fuse.js pour recherche floue
        this.fuseConfig = {
            keys: [
                { name: 'poste', weight: 0.4 },
                { name: 'description_nettoyee', weight: 0.3 },
                { name: 'contrat', weight: 0.2 },
                { name: 'entreprise', weight: 0.1 }
            ],
            threshold: 0.4,
            includeScore: true,
            minMatchCharLength: 2,
            ignoreLocation: true
        };

        // Mots vides français
        this.stopWords = new Set([
            'je', 'tu', 'il', 'elle', 'nous', 'vous', 'ils', 'elles', 
            'le', 'la', 'les', 'un', 'une', 'des', 'du', 'de', 'et', 
            'ou', 'où', 'que', 'qui', 'quoi', 'pour', 'par', 'avec', 
            'dans', 'sur', 'chez', 'vers', 'à', 'en', 'ce', 'mon', 
            'ma', 'son', 'sa', 'notre', 'votre', 'leur', 'cherche', 
            'recherche', 'poste', 'emploi', 'travail', 'job'
        ]);
    }

    // Analyse intelligente de la requête
    analyzeQuery(query) {
        const tokens = this.tokenize(query);
        const expanded = this.expandSynonyms(tokens);
        const intent = this.detectIntent(query);
        
        return {
            original: tokens,
            expanded: expanded,
            intent: intent
        };
    }

    // Tokenisation et nettoyage
    tokenize(text) {
        return text.toLowerCase()
            .replace(/[^\w\sàáâãäåæçèéêëìíîïñòóôõöøùúûüýÿ]/g, ' ')
            .split(/\s+/)
            .filter(token => token.length > 1)
            .filter(token => !this.stopWords.has(token));
    }

    // Expansion avec synonymes
    expandSynonyms(tokens) {
        const expanded = new Set(tokens);
        
        tokens.forEach(token => {
            Object.keys(this.synonyms).forEach(key => {
                if (key.includes(token) || this.synonyms[key].includes(token)) {
                    expanded.add(key);
                    this.synonyms[key].forEach(syn => expanded.add(syn));
                }
            });
        });
        
        return Array.from(expanded);
    }

    // Détection d'intention dans la requête
    detectIntent(query) {
        const intent = {};
        const lowerQuery = query.toLowerCase();
        
        // Détection de localisation
        const locationMatch = lowerQuery.match(/(?:à|dans|région|ville)\s+(\w+)/i);
        if (locationMatch) intent.location = locationMatch[1];
        
        // Détection de type de contrat
        const contractMatch = lowerQuery.match(/(cdi|cdd|stage|alternance|freelance|temps partiel|temps plein)/i);
        if (contractMatch) intent.contract = contractMatch[1];
        
        // Détection de niveau
        const levelMatch = lowerQuery.match(/(junior|senior|débutant|expérimenté|confirmé)/i);
        if (levelMatch) intent.level = levelMatch[1];
        
        return intent;
    }

    // Recherche hybride améliorée
    smartSearch(query, jobsData) {
        const analysis = this.analyzeQuery(query);
        
        // 1. Recherche exacte avec termes étendus
        const exactResults = this.exactSearch(analysis.expanded, jobsData);
        
        // 2. Recherche floue avec Fuse.js
        const fuse = new Fuse(jobsData, this.fuseConfig);
        const fuseResults = fuse.search(query);
        
        // 3. Combiner et scorer les résultats
        const combinedResults = this.combineResults(exactResults, fuseResults, analysis.intent);
        
        return combinedResults;
    }

    exactSearch(expandedTerms, jobsData) {
        return jobsData.map((job, index) => {
            const jobText = this.getJobSearchText(job);
            let score = 0;
            let matchedTerms = [];
            
            expandedTerms.forEach(term => {
                if (jobText.includes(term.toLowerCase())) {
                    // Score plus élevé si trouvé dans le titre
                    if (job.poste.toLowerCase().includes(term.toLowerCase())) {
                        score += 5;
                    } else {
                        score += 2;
                    }
                    matchedTerms.push(term);
                }
            });
            
            return { 
                index, 
                score, 
                matchedTerms, 
                type: 'exact'
            };
        }).filter(result => result.score > 0);
    }

    combineResults(exactResults, fuseResults, intent) {
        const resultMap = new Map();
        
        // Ajouter résultats exacts
        exactResults.forEach(result => {
            resultMap.set(result.index, {
                index: result.index,
                score: result.score,
                matchedTerms: result.matchedTerms,
                types: ['exact']
            });
        });
        
        // Ajouter résultats Fuse.js
        fuseResults.forEach(result => {
            const index = result.refIndex;
            const fuseScore = (1 - result.score) * 3; // Convertir en score positif
            
            if (resultMap.has(index)) {
                resultMap.get(index).score += fuseScore;
                resultMap.get(index).types.push('fuzzy');
            } else {
                resultMap.set(index, {
                    index: index,
                    score: fuseScore,
                    matchedTerms: [],
                    types: ['fuzzy']
                });
            }
        });
        
        // Appliquer bonus d'intention
        this.applyIntentBonus(resultMap, intent);
        
        // Trier par score décroissant
        return Array.from(resultMap.values())
            .sort((a, b) => b.score - a.score);
    }

    applyIntentBonus(resultMap, intent) {
        if (Object.keys(intent).length === 0) return;
        
        resultMap.forEach((result, index) => {
            const jobElement = document.querySelectorAll('.job-card')[index];
            if (!jobElement) return;
            
            const jobText = this.getJobElementText(jobElement);
            
            // Bonus si l'intention correspond
            if (intent.contract && jobText.includes(intent.contract.toLowerCase())) {
                result.score += 3;
            }
            if (intent.level && jobText.includes(intent.level.toLowerCase())) {
                result.score += 2;
            }
            if (intent.location && jobText.includes(intent.location.toLowerCase())) {
                result.score += 2;
            }
        });
    }

    getJobSearchText(job) {
        return `${job.poste} ${job.entreprise} ${job.description_nettoyee} ${job.contrat}`.toLowerCase();
    }

    getJobElementText(jobElement) {
        const title = jobElement.querySelector('.job-title')?.textContent || '';
        const company = jobElement.querySelector('.job-company')?.textContent || '';
        const description = jobElement.querySelector('.job-description-text')?.textContent || '';
        const infoItems = Array.from(jobElement.querySelectorAll('.job-info-item span'))
            .map(span => span.textContent).join(' ');
        
        return `${title} ${company} ${description} ${infoItems}`.toLowerCase();
    }
}

class JobsPagination {
    constructor(jobsPerPage = 8) {
        this.jobsPerPage = jobsPerPage;
        this.currentPage = 1;
        this.allJobs = document.querySelectorAll('.job-card');
        this.filteredJobs = [...this.allJobs];
        this.totalJobs = this.allJobs.length;
        this.totalPages = Math.ceil(this.totalJobs / this.jobsPerPage);
        
        this.searchInput = document.getElementById('searchInput');
        this.clearButton = document.getElementById('clearSearch');
        this.searchResultsInfo = document.getElementById('searchResultsInfo');
        
        // Initialiser la recherche intelligente
        this.smartSearch = new SmartJobSearch();
        
        this.init();
        this.initSearch();
        this.calculateStats();
    }

    init() {
        this.showPage(1);
        this.renderPagination();
    }

    initSearch() {
        let searchTimeout;
        this.searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.performSmartSearch(e.target.value);
            }, 300);
            
            this.clearButton.style.display = e.target.value ? 'flex' : 'none';
        });

        this.clearButton.addEventListener('click', () => {
            this.searchInput.value = '';
            this.clearButton.style.display = 'none';
            this.clearSearch();
        });

        this.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.performSmartSearch(e.target.value);
            }
        });
    }

    performSmartSearch(query) {
        if (!query.trim()) {
            this.clearSearch();
            return;
        }

        // Préparer les données pour la recherche
        const jobsData = this.getAllJobsData();
        
        // Utiliser la recherche intelligente
        const results = this.smartSearch.smartSearch(query, jobsData);
        
        // Convertir en format attendu
        this.filteredJobs = results.map(result => ({
            element: this.allJobs[result.index],
            score: result.score,
            terms: result.matchedTerms || []
        }));

        this.updateSearchResults();
    }

    getAllJobsData() {
        return Array.from(this.allJobs).map(jobElement => ({
            poste: jobElement.querySelector('.job-title')?.textContent || '',
            entreprise: jobElement.querySelector('.job-company')?.textContent || '',
            description_nettoyee: jobElement.querySelector('.job-description-text')?.textContent || '',
            contrat: Array.from(jobElement.querySelectorAll('.job-info-item span'))[1]?.textContent || ''
        }));
    }

    updateSearchResults() {
        // Masquer toutes les offres
        this.allJobs.forEach(job => {
            job.classList.add('hidden');
        });

        // Mettre à jour les compteurs
        this.totalJobs = this.filteredJobs.length;
        this.totalPages = Math.ceil(this.totalJobs / this.jobsPerPage);
        this.currentPage = 1;

        // Afficher les informations de recherche
        if (this.filteredJobs.length === 0) {
            this.searchResultsInfo.innerHTML = '<span style="color: #ef4444;">Aucune offre trouvée pour cette recherche</span>';
        } else {
            const searchTerms = this.filteredJobs[0]?.terms?.join(', ') || '';
            this.searchResultsInfo.innerHTML = `
                <span style="color: #10b981;">
                    ${this.filteredJobs.length} offre${this.filteredJobs.length > 1 ? 's' : ''} trouvée${this.filteredJobs.length > 1 ? 's' : ''}
                    ${searchTerms ? ` - Mots-clés détectés: ${searchTerms}` : ''}
                </span>
            `;
        }

        // Mettre à jour le compteur principal
        document.getElementById('totalCount').textContent = `${this.filteredJobs.length} offre${this.filteredJobs.length > 1 ? 's' : ''}`;

        // Mettre à jour les statistiques pour les résultats filtrés
        this.updateSearchStats();

        this.showFilteredPage(1);
        this.renderPagination();
    }

    clearSearch() {
        this.filteredJobs = [...this.allJobs];
        this.totalJobs = this.allJobs.length;
        this.totalPages = Math.ceil(this.totalJobs / this.jobsPerPage);
        this.currentPage = 1;
        
        this.searchResultsInfo.innerHTML = '';
        document.getElementById('totalCount').textContent = `${this.totalJobs} offre${this.totalJobs > 1 ? 's' : ''}`;
        
        // Remettre les statistiques d'origine
        this.calculateStats();
        
        this.showPage(1);
        this.renderPagination();
    }

    showPage(page) {
        this.currentPage = page;
        
        // Masquer toutes les offres
        this.allJobs.forEach(job => {
            job.style.display = 'none';
            job.classList.remove('hidden');
        });

        // Afficher les offres de la page courante
        const start = (page - 1) * this.jobsPerPage;
        const end = start + this.jobsPerPage;
        
        for (let i = start; i < end && i < this.totalJobs; i++) {
            this.allJobs[i].style.display = 'flex';
        }

        this.renderPagination();
    }

    showFilteredPage(page) {
        this.currentPage = page;
        
        // Masquer toutes les offres
        this.allJobs.forEach(job => {
            job.style.display = 'none';
            job.classList.add('hidden');
        });

        // Afficher les offres filtrées de la page courante
        const start = (page - 1) * this.jobsPerPage;
        const end = start + this.jobsPerPage;
        
        for (let i = start; i < end && i < this.filteredJobs.length; i++) {
            this.filteredJobs[i].element.style.display = 'flex';
            this.filteredJobs[i].element.classList.remove('hidden');
        }

        this.renderPagination();
    }

    renderPagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (this.totalPages <= 1) {
            return;
        }

        // Bouton précédent
        const prevButton = this.createNavButton('‹', this.currentPage - 1, this.currentPage === 1);
        pagination.appendChild(prevButton);

        // Logique de pagination intelligente
        const pages = this.getPageNumbers();
        
        pages.forEach((page, index) => {
            if (page === '...') {
                const dots = document.createElement('span');
                dots.className = 'pagination-dots';
                dots.textContent = '...';
                pagination.appendChild(dots);
            } else {
                const pageButton = this.createPageButton(page, page === this.currentPage);
                pagination.appendChild(pageButton);
            }
        });

        // Bouton suivant
        const nextButton = this.createNavButton('›', this.currentPage + 1, this.currentPage === this.totalPages);
        pagination.appendChild(nextButton);
    }

    getPageNumbers() {
        const pages = [];
        const current = this.currentPage;
        const total = this.totalPages;

        if (total <= 7) {
            for (let i = 1; i <= total; i++) {
                pages.push(i);
            }
        } else {
            pages.push(1);

            if (current <= 4) {
                for (let i = 2; i <= 5; i++) {
                    pages.push(i);
                }
                pages.push('...');
                pages.push(total);
            } else if (current >= total - 3) {
                pages.push('...');
                for (let i = total - 4; i <= total; i++) {
                    pages.push(i);
                }
            } else {
                pages.push('...');
                for (let i = current - 1; i <= current + 1; i++) {
                    pages.push(i);
                }
                pages.push('...');
                pages.push(total);
            }
        }

        return pages;
    }

    createPageButton(page, isActive) {
        const button = document.createElement('a');
        button.className = `pagination-item ${isActive ? 'active' : ''}`;
        button.textContent = page;
        button.href = '#';
        
        button.addEventListener('click', (e) => {
            e.preventDefault();
            if (this.searchInput.value.trim()) {
                this.showFilteredPage(page);
            } else {
                this.showPage(page);
            }
        });

        return button;
    }

    createNavButton(symbol, targetPage, isDisabled) {
        const button = document.createElement('a');
        button.className = `pagination-nav ${isDisabled ? 'disabled' : ''}`;
        button.innerHTML = symbol;
        button.href = '#';

        if (!isDisabled) {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                if (this.searchInput.value.trim()) {
                    this.showFilteredPage(targetPage);
                } else {
                    this.showPage(targetPage);
                }
            });
        }

        return button;
    }

    calculateStats() {
        const stats = {
            alternance: 0,
            cdi: 0,
            cdd: 0,
            stage: 0,
            sansDiplome: 0,
            junior: 0
        };

        this.allJobs.forEach(job => {
            const jobText = this.smartSearch.getJobElementText(job);
            
            // Analyser le type de contrat
            if (jobText.includes('alternance')) stats.alternance++;
            if (jobText.includes('cdi')) stats.cdi++;
            if (jobText.includes('cdd')) stats.cdd++;
            if (jobText.includes('stage')) stats.stage++;
            
            // Analyser les exigences
            if (jobText.includes('sans diplôme') || 
                jobText.includes('sans diplome') || 
                jobText.includes('aucun diplôme') ||
                jobText.includes('pas de diplôme')) {
                stats.sansDiplome++;
            }
            
            // Analyser le niveau
            if (jobText.includes('junior') || 
                jobText.includes('débutant') || 
                jobText.includes('premier emploi') ||
                jobText.includes('entry level')) {
                stats.junior++;
            }
        });

        this.updateStatsDisplay(stats);
    }

    updateStatsDisplay(stats) {
        document.getElementById('statAlternance').textContent = stats.alternance;
        document.getElementById('statCDI').textContent = stats.cdi;
        document.getElementById('statCDD').textContent = stats.cdd;
        document.getElementById('statStage').textContent = stats.stage;
        document.getElementById('statSansDiplome').textContent = stats.sansDiplome;
        document.getElementById('statJunior').textContent = stats.junior;
    }

    updateSearchStats() {
        if (this.filteredJobs.length === 0 || this.searchInput.value.trim() === '') {
            this.calculateStats();
            return;
        }

        const stats = {
            alternance: 0,
            cdi: 0,
            cdd: 0,
            stage: 0,
            sansDiplome: 0,
            junior: 0
        };

        this.filteredJobs.forEach(jobObj => {
            const jobText = this.smartSearch.getJobElementText(jobObj.element);
            
            if (jobText.includes('alternance')) stats.alternance++;
            if (jobText.includes('cdi')) stats.cdi++;
            if (jobText.includes('cdd')) stats.cdd++;
            if (jobText.includes('stage')) stats.stage++;
            
            if (jobText.includes('sans diplôme') || 
                jobText.includes('sans diplome') || 
                jobText.includes('aucun diplôme') ||
                jobText.includes('pas de diplôme')) {
                stats.sansDiplome++;
            }
            
            if (jobText.includes('junior') || 
                jobText.includes('débutant') || 
                jobText.includes('premier emploi') ||
                jobText.includes('entry level')) {
                stats.junior++;
            }
        });

        this.updateStatsDisplay(stats);
    }
}

// Initialiser la pagination quand la page est chargée
document.addEventListener('DOMContentLoaded', function() {
    new JobsPagination(8); // 8 offres par page
});
</script> this.jobsPerPage;
        
        for (let i = start; i < end && i < this.totalJobs; i++) {
            this.allJobs[i].style.display = 'flex';
        }

        this.renderPagination();
    }

    showFilteredPage(page) {
        this.currentPage = page;
        
        // Masquer toutes les offres
        this.allJobs.forEach(job => {
            job.style.display = 'none';
            job.classList.add('hidden');
        });

        // Afficher les offres filtrées de la page courante
        const start = (page - 1) * this.jobsPerPage;
        const end = start + this.jobsPerPage;
        
        for (let i = start; i < end && i < this.filteredJobs.length; i++) {
            this.filteredJobs[i].element.style.display = 'flex';
            this.filteredJobs[i].element.classList.remove('hidden');
        }

        this.renderPagination();
    }

    renderPagination() {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (this.totalPages <= 1) {
            return; // Pas de pagination nécessaire
        }

        // Bouton précédent
        const prevButton = this.createNavButton('‹', this.currentPage - 1, this.currentPage === 1);
        pagination.appendChild(prevButton);

        // Logique de pagination intelligente
        const pages = this.getPageNumbers();
        
        pages.forEach((page, index) => {
            if (page === '...') {
                const dots = document.createElement('span');
                dots.className = 'pagination-dots';
                dots.textContent = '...';
                pagination.appendChild(dots);
            } else {
                const pageButton = this.createPageButton(page, page === this.currentPage);
                pagination.appendChild(pageButton);
            }
        });

        // Bouton suivant
        const nextButton = this.createNavButton('›', this.currentPage + 1, this.currentPage === this.totalPages);
        pagination.appendChild(nextButton);
    }

    getPageNumbers() {
        const pages = [];
        const current = this.currentPage;
        const total = this.totalPages;

        if (total <= 7) {
            // Si 7 pages ou moins, afficher toutes
            for (let i = 1; i <= total; i++) {
                pages.push(i);
            }
        } else {
            // Toujours afficher la première page
            pages.push(1);

            if (current <= 4) {
                // Au début
                for (let i = 2; i <= 5; i++) {
                    pages.push(i);
                }
                pages.push('...');
                pages.push(total);
            } else if (current >= total - 3) {
                // À la fin
                pages.push('...');
                for (let i = total - 4; i <= total; i++) {
                    pages.push(i);
                }
            } else {
                // Au milieu
                pages.push('...');
                for (let i = current - 1; i <= current + 1; i++) {
                    pages.push(i);
                }
                pages.push('...');
                pages.push(total);
            }
        }

        return pages;
    }

    createPageButton(page, isActive) {
        const button = document.createElement('a');
        button.className = `pagination-item ${isActive ? 'active' : ''}`;
        button.textContent = page;
        button.href = '#';
        
        button.addEventListener('click', (e) => {
            e.preventDefault();
            if (this.searchInput.value.trim()) {
                this.showFilteredPage(page);
            } else {
                this.showPage(page);
            }
        });

        return button;
    }

    calculateStats() {
        const stats = {
            alternance: 0,
            cdi: 0,
            cdd: 0,
            stage: 0,
            sansDiplome: 0,
            junior: 0
        };

        this.allJobs.forEach(job => {
            const jobText = this.getJobSearchableText(job).toLowerCase();
            
            // Analyser le type de contrat
            if (jobText.includes('alternance')) stats.alternance++;
            if (jobText.includes('cdi')) stats.cdi++;
            if (jobText.includes('cdd')) stats.cdd++;
            if (jobText.includes('stage')) stats.stage++;
            
            // Analyser les exigences
            if (jobText.includes('sans diplôme') || 
                jobText.includes('sans diplome') || 
                jobText.includes('aucun diplôme') ||
                jobText.includes('pas de diplôme')) {
                stats.sansDiplome++;
            }
            
            // Analyser le niveau
            if (jobText.includes('junior') || 
                jobText.includes('débutant') || 
                jobText.includes('premier emploi') ||
                jobText.includes('entry level')) {
                stats.junior++;
            }
        });

        this.updateStatsDisplay(stats);
    }

    updateStatsDisplay(stats) {
        document.getElementById('statAlternance').textContent = stats.alternance;
        document.getElementById('statCDI').textContent = stats.cdi;
        document.getElementById('statCDD').textContent = stats.cdd;
        document.getElementById('statStage').textContent = stats.stage;
        document.getElementById('statSansDiplome').textContent = stats.sansDiplome;
        document.getElementById('statJunior').textContent = stats.junior;
    }

    updateSearchStats() {
        if (this.filteredJobs.length === 0 || this.searchInput.value.trim() === '') {
            this.calculateStats();
            return;
        }

        const stats = {
            alternance: 0,
            cdi: 0,
            cdd: 0,
            stage: 0,
            sansDiplome: 0,
            junior: 0
        };

        this.filteredJobs.forEach(jobObj => {
            const jobText = this.getJobSearchableText(jobObj.element).toLowerCase();
            
            if (jobText.includes('alternance')) stats.alternance++;
            if (jobText.includes('cdi')) stats.cdi++;
            if (jobText.includes('cdd')) stats.cdd++;
            if (jobText.includes('stage')) stats.stage++;
            
            if (jobText.includes('sans diplôme') || 
                jobText.includes('sans diplome') || 
                jobText.includes('aucun diplôme') ||
                jobText.includes('pas de diplôme')) {
                stats.sansDiplome++;
            }
            
            if (jobText.includes('junior') || 
                jobText.includes('débutant') || 
                jobText.includes('premier emploi') ||
                jobText.includes('entry level')) {
                stats.junior++;
            }
        });

        this.updateStatsDisplay(stats);
    }

    createNavButton(symbol, targetPage, isDisabled) {
        const button = document.createElement('a');
        button.className = `pagination-nav ${isDisabled ? 'disabled' : ''}`;
        button.innerHTML = symbol;
        button.href = '#';

        if (!isDisabled) {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                if (this.searchInput.value.trim()) {
                    this.showFilteredPage(targetPage);
                } else {
                    this.showPage(targetPage);
                }
            });
        }

        return button;
    }
}

// Initialiser la pagination quand la page est chargée
document.addEventListener('DOMContentLoaded', function() {
    new JobsPagination(8); // 8 offres par page
});
</script>
{% endblock %}
